name: Deploy to Pressidium
on:
  push:
    branches:
      - main
    paths-ignore:

      - '.vscode/**'
      - 'README.md'
      - 'GEMINI.md'
      - 'bin/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set environment variables (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "SFTP_USER=${{ secrets.SFTP_PROD_USER }}" >> $GITHUB_ENV
          echo "SFTP_PASS=${{ secrets.SFTP_PROD_PASS }}" >> $GITHUB_ENV
          # TODO: Replace YOUR_INSTALLATION_NAME with your actual Pressidium installation name
          echo "DEPLOY_PATH=/YOUR_INSTALLATION_NAME-www/wp-content/themes/hands-and-vision" >> $GITHUB_ENV



      - name: Set outputs
        id: sftp_details
        run: |
          echo "user=${SFTP_USER}" >> $GITHUB_OUTPUT
          # Mask the password in logs just in case, though secrets are masked by default
          echo "::add-mask::${SFTP_PASS}"
          echo "pass=${SFTP_PASS}" >> $GITHUB_OUTPUT
          echo "deploy_path=${DEPLOY_PATH}" >> $GITHUB_OUTPUT

      - name: Deploy via SFTP
        uses: pressidium/lftp-mirror-action@v1
        with:
          host: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT }}
          user: ${{ steps.sftp_details.outputs.user }}
          pass: ${{ steps.sftp_details.outputs.pass }}
          remoteDir: ${{ steps.sftp_details.outputs.deploy_path }}
          options: '--verbose --exclude-glob .git*'
